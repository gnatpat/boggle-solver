<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Boggle Labeling Tool</title>
    <style>
        body {
            font-family: sans-serif;
            margin: 20px;
        }

        #image {
            border: 1px solid #ccc;
            width: 80px;
            /* aspect-ratio: 1/1; */
            height: auto;
            display: block;
            margin-bottom: 10px;
        }

        #entered {
            font-size: 48px;
        }

        .keyboard button {
            margin: 2px;
            padding: 8px;
        }

        #progress {
            margin: 10px 0;
            font-weight: bold;
        }

        .image-and-label {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .label {
            font-weight: bold;
            margin-left: 10px;
            margin-top: auto;
            margin-bottom: auto;
            font-size: 48px;
            height: fit-content;
        }
    </style>
</head>

<body>
    <h1>Boggle Labeling Tool</h1>

    <div id="progress">Progress: â€¦</div>

    <div id="imageAndLabel" class="image-and-label">
        <img id="image" src="" alt="letter" />
        <div id="entered" class="label"></div>
    </div>

    <div id="help">
        An = 1, Er = 2, He = 3, In = 4, Th = 5
    </div>

    <div id="filename"></div>
    <button id="refreshBtn">ðŸ”„ Refresh Files</button>

    <button id="viewToggle">See All</button>
    <div id="imageList"></div>

    <script>
        let currentImageId = null;
        let previousImageId = null;
        let entered = null;

        async function fetchProgress() {
            const res = await fetch("/progress");
            const data = await res.json();
            const el = document.getElementById("progress");
            el.textContent = `Progress: ${data.labeled}/${data.total} labeled (${data.remaining} remaining)`;
            if (data.done) {
                el.textContent += " âœ… All done!";
            }
        }

        async function loadNext() {
            previousImageId = currentImageId;
            const res = await fetch("/next");
            const data = await res.json();
            console.log(data)
            if (data.done) {
                document.getElementById("image").style.display = "none";
                document.getElementById("filename").textContent = "All images labeled!";
                fetchProgress();
                return;
            }
            setCurrentImage(data);
            fetchProgress();
        }

        function setCurrentImage(data) {
            currentImageId = data.image_id;
            document.getElementById("image").src = data.raw_path;
            document.getElementById("filename").textContent = data.raw_path;
        }

        async function sendLabel(label) {
            console.log(currentImageId)
            if (!currentImageId) return;
            // encode the label in case it's a question mark
            if (label === "?") {
                label = encodeURIComponent(label);
            }
            await fetch(`/label/${currentImageId}/${label}`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
            });
            await loadNext();
        }

        document.getElementById("refreshBtn").onclick = async () => {
            await fetch("/refresh");
            loadNext();
        };

        // Keyboard shortcuts: press Aâ€“Z or ? to label quickly
        document.addEventListener("keydown", async (e) => {
            if (e.repeat) return; // ignore repeats
            // if modifier key is pressed, ignore
            if (e.altKey || e.ctrlKey || e.metaKey) return;
            const k = e.key.toUpperCase();
            if (/^[A-Z1-5?]$/.test(k)) {
                entered = k;
                if (k === "1") entered = "AN";
                if (k === "2") entered = "ER";
                if (k === "3") entered = "HE";
                if (k === "4") entered = "IN";
                if (k === "5") entered = "TH";
                document.querySelector("#entered").textContent = entered;
                // send label after small delay
                setTimeout(async () => {
                    if (entered) {
                        await sendLabel(entered);
                    }
                    entered = null;
                    document.querySelector("#entered").textContent = "";
                }, 300);
            }
            // if backspace, clear the entered label
            if (e.key === "Backspace") {
                if (entered) {
                    document.querySelector("#entered").textContent = "";
                    entered = null;
                } else {
                    // use previous image id
                    if (previousImageId) {
                        currentImageId = previousImageId;
                        previousImageId = null;
                        const res = await fetch(`/image_id/${currentImageId}`);
                        const data = await res.json();
                        setCurrentImage(data);
                    }
                }
            }
        });

        document.querySelector("#viewToggle").onclick = async () => {
            const list = document.getElementById("imageList");
            if (list.style.display === "block") {
                list.style.display = "none";
                document.querySelector("#viewToggle").textContent = "See All";
            } else {
                list.style.display = "block";
                document.querySelector("#viewToggle").textContent = "Hide All";
                // Load all images into the list
                await loadAllImages();
            }
        };

        async function loadAllImages() {
            const res = await fetch("/images");
            const data = await res.json();
            const list = document.getElementById("imageList");
            list.innerHTML = "";
            for (const image of data.images) {
                const item = document.createElement("div");
                const idDiv = document.createElement('div')
                idDiv.textContent = `ID: ${image.image_id}`;
                item.appendChild(idDiv);
                const imageAndLabel = document.createElement('div');
                imageAndLabel.classList.add("image-and-label");
                const img = document.createElement("img");
                img.src = image.raw_path;
                imageAndLabel.appendChild(img);
                const labelSpan = document.createElement('span');
                labelSpan.textContent = `${image.label || "-"}`;
                labelSpan.classList.add("label");
                imageAndLabel.appendChild(labelSpan);
                item.appendChild(imageAndLabel);
                const editButton = document.createElement("button");
                editButton.textContent = "Edit";
                editButton.onclick = () => {
                    setCurrentImage(image);
                };
                item.appendChild(editButton);
                list.appendChild(item);
            }
        }

        loadNext();
    </script>
</body>

</html>